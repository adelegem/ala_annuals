---
title: "annual plants are cool"
format:
  html:
    embed-resources: true
editor: visual
execute:
  warning: false
  output: true
---

```{r}

#devtools::install_github("traitecoevo/austraits")
#install.packages("remotes")
#remotes::install_github("AtlasOfLivingAustralia/galah")

library(tidyverse)
library(austraits)
library(galah)
austraits <- load_austraits(version = "4.1.0", path = "intro/downloads")

```

## Extracting life form traits from austraits

```{r}
#extract life history traits
annual_perennial_traits <- austraits %>% extract_trait('life_history')

#down with tibbles
annual_perennial_traits <- left_join(annual_perennial_traits[["traits"]], annual_perennial_traits[["taxa"]], by = "taxon_name")

#unique taxa with life history traits
length(unique(annual_perennial_traits$taxon_name))
#28332

#different life history values
unique(annual_perennial_traits$value)
# [1] "perennial"                                       "biennial perennial"       # [3] "annual"                                          "annual perennial"         # [5] "biennial"                                        "annual biennial"          # [7] "annual short_lived_perennial"                    "ephemeral"                # [9] "short_lived_perennial"                           "annual ephemeral"        #[11] "annual biennial perennial"                       "biennial short_lived_perennial"                 
#[13] "annual ephemeral perennial"                      "annual biennial short_lived_perennial"          
#[15] "perennial short_lived_perennial"                 "biennial perennial short_lived_perennial"       
#[17] "annual perennial short_lived_perennial"          "ephemeral short_lived_perennial"                
#[19] "ephemeral perennial"                             "annual biennial perennial short_lived_perennial"
#surely a 'ephemeral perennial short lived perennial is an annual????

annual_trait <- unique(annual_perennial_traits$value[grepl("annual", annual_perennial_traits$value)])


#number of records with 'annual' value
sum(annual_perennial_traits$value %in% annual_trait)
#12441

write.csv(annual_perennial_traits, 'data_out/life_form_traits.csv')

#records of annuals
annual_species_data <- subset(annual_perennial_traits, value %in% annual_trait)

write.csv(annual_species_data, 'data_out/annual_species.csv')

annual_perennial_traits <- read.csv('data_out/life_form_traits.csv')

annual_species_data <- read.csv('data_out/annual_species.csv')

#vector containing names of all annual taxa from austraits
annual_species <- unique(annual_species_data$taxon_name)

#unique taxa with at least one record of annual life history form
length(unique(annual_species_data$taxon_name))
#4427

family_counts <- annual_species_data %>%
  group_by(family) %>%
  summarize(count = n()) %>%
  arrange(desc(count))
family_counts

ast_annual <- annual_species_data %>%
  filter(family == 'Asteraceae',
         taxon_rank == 'Species')

#vector of names of annual asteraceae species
ast_annual <- unique(ast_annual$taxon_name)


```

## Obtaining counts for Asteraceae/all annual species

```{r}

#empty list to storecounts
#all_counts <- list()

#counts for species in annual_species
#for (species in annual_species) {
#  counts <- galah_call() %>%
#    galah_identify(species) %>%
#    atlas_counts()
#  
#  all_counts[[species]] <- counts
#}

# empty list to store counts
#ast_counts <- list()

#for (species in ast_annual) {
#  counts <- galah_call() %>%
#    galah_identify(species) %>%
#    atlas_counts()
#  
#  ast_counts[[species]] <- counts
#}


```

## Animated map of Asteraceae annual species by month

```{r}
## animated map of asteraceae annual plants (based on austraits)
#install.packages('gganimate')
#install.packages('gifski')
library(ggplot2)
library(gganimate)
library(gifski)
library(sf)
library(ozmaps)

galah_config(email = 'adelegemmell@hotmail.com')

ast_all <- galah_call() |>
  galah_identify('Asteraceae') |>
  galah_filter(country == 'Australia') |>
  galah_apply_profile(ALA) |>
  atlas_occurrences()


ast_annual_ala <- ast_all %>%
  subset(scientificName %in% ast_annual) %>%
  drop_na(decimalLongitude, eventDate) 


sum(unique(ast_annual_ala$scientificName) %in% ast_annual) 
#623 species from ALA out of 631 asteraceae annual species from austraits 

ast_annual_df <- data.frame(species = ast_annual)

ast_annual_df$ala <- ast_annual_df$species %in% ast_annual_ala$scientificName 

ast_annual_df$species[ast_annual_df$ala == FALSE]
#extinct, poorly known taxa, or taxonomic issues eg ("Senecio productus" "Senecio serratiformis")


ast_annual_ala$year <- substr(ast_annual_ala$eventDate, 1, 4)

ast_annual_ala$month <- substr(ast_annual_ala$eventDate, 6, 7)

ast_annual_ala$month <- as.numeric(ast_annual_ala$month)

ast_annual_ala$months <- month.name[(ast_annual_ala$month)]

ast_annual_ala$months <- factor(ast_annual_ala$months, levels = c("January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"))

aus <- ozmaps::ozmap_country |>
  st_transform(crs = st_crs(4326))

map <- ggplot() +
  geom_sf(data = aus,
          fill = NA,
          colour = "grey60") +
  geom_point(data = ast_annual_ala,
             aes(x = decimalLongitude,
                 y = decimalLatitude,
                 color = months)) +
  labs(legend = 'Month') +
  theme_void()
map


map_anime <- map +
  transition_time(month) +
  ggtitle('Asteraceae annual plant records by month \n Month: {frame_time}',
          subtitle = 'Frame {frame} of {nframes}')
num_month <- max(ast_annual_ala$month) - min(ast_annual_ala$month) + 1
animate(map_anime, nframes = num_month, duration = 6)
```
