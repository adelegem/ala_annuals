---
title: "fire_ephemerals"
format:
  html:
    embed-resources: true
editor: visual
execute:
  warning: false
  output: true
---

## Fire Ephemerals in NSW

Fire ephemerals are plant species which grow in response to fire, and typically have short life spans, growing, flowering seeding, and dying after fire events. This unique life history trait gives them an advantage in that they grow when competition for resources is reduced and light and nutrients are more abundant. This trait makes them elusive however, with a short window for them to be recorded, which in turn makes [conservation assessment of these species difficult](https://www.anpc.asn.au/wp-content/uploads/2022/07/APC_30-2_Sept-Nov21_Bell-v1.pdf).

In this post, we will use R code and the galah package to identify the distribution of fire ephemerals in NSW against historical fire data from the National Parks and Wildlife Services Fire History dataset.

### Load packages and NSW Fire dataset

You will need to download the NPWS fire history dataset and save it to your directory. You can access it [here](https://datasets.seed.nsw.gov.au/dataset/fire-history-wildfires-and-prescribed-burns-1e8b6).

```{r}
#install.packages("pacman")
#pacman::p_load(tidyverse, here, rmapshaper, sf, ggpointdensity, viridis, ozmaps, concaveman, cowplot, patchwork)
library(maps)
library(mapdata)
library(tidyverse)
library(sf)
library(extrafont)
library(here)
library(ozmaps)
library(ggthemes)
library(galah)

#load the dataset, transforming into WGS84 CRS 
fire <- st_read(here("NPWS_fire", "NPWSFireHistory.shp")) |> 
  st_transform(crs = 4326) |> 
  st_zm()  # Remove Z or M values

#add start year
fire$StartYear <- substr(fire$StartDate, 1, 4)

#Some fires have an arbitary 'start year' of 1899 where the start date is unknown, even if they are labelled as '1996-97 wildfire'. replace start year for these records with the year given in the 'Label' field. The fire dataset begins in 1902

fire <-  fire %>%
  mutate(StartYear = ifelse(is.na(StartYear) | StartYear == '1899', substr(Label, 1, 4), StartYear))

#create nswv polygon using ozmaps package
sf_oz <- ozmap_data("states") |>
  st_transform(crs = 4326)

nsw <- sf_oz %>%
  filter(NAME == 'New South Wales')

```

## Get distribution data on fire ephemerals in NSW

Based on [this paper](https://www.anpc.asn.au/wp-content/uploads/2022/07/APC_30-2_Sept-Nov21_Bell-v1.pdf) by Bell, six NSW fire ephemeral species are selected:

1.  Actinotus forsythii
2.   Monotaxis macrophylla
3.  Gyrostemon australasicus
4.  Gyrostemon thesioides
5.  Androcalva procumbens
6.  Androcalva rosea
7.  Commersonia rugosa

```{r}

#configure your email to access atlas occurence data from the galah package
galah_config(email = 'adelegemmell@hotmail.com')

#access ALA occurence data for ephemeral species in NSW
fire_ephemerals <- galah_call() |>
  galah_identify('Actinotus forsythii', 'Monotaxis macrophylla', 'Gyrostemon australasicus', 'Gyrostemon thesioides', 'Androcalva procumbens', 'Androcalva rosea', 'Commersonia rugosa') |>
  galah_filter(cl22 == 'New South Wales') |>
  galah_apply_profile(ALA) |> #applies data quality checks
  atlas_occurrences()


#you can see all available fields using the show_all_fields commands
show_all_fields() |>
  View()

#i want to include conservation status in my analyses, so I can search for fields which relate to this
search_fields('status') |>
  View()

#select fields that I want included in my fire_ephemerals dataset
select <- c(colnames(fire_ephemerals)[1:8], "countryConservation", "stateConservation")
  
#access ALA occurence data for ephemeral species in NSW, including conservation status
fire_ephemerals <- galah_call() |>
  galah_identify('Actinotus forsythii', 'Monotaxis macrophylla', 'Gyrostemon australasicus', 'Gyrostemon thesioides', 'Androcalva procumbens', 'Androcalva rosea', 'Commersonia rugosa') |>
  galah_filter(cl22 == 'New South Wales') |>
  galah_select(select) |>
  galah_apply_profile(ALA) |>
  atlas_occurrences()

#see occurence counts for each species
fire_ephemerals %>% 
  group_by(scientificName) %>%
  summarise(count = n())

#apply year column based on 'event date' for comparison with fire history
fire_ephemerals$year <- substr(fire_ephemerals$eventDate, 1, 4)

```

## Map fire ephemerals in NSW

```{r}
ggplot() +
  geom_sf(data = nsw,
          fill = NA,
          colour = "grey60") +
  geom_point(data = fire_ephemerals,
             aes(x = decimalLongitude,
                 y = decimalLatitude,
                 color = scientificName)) +
  labs(color = 'Species') +
  theme_void()
```

## Map against fire history

```{r}
#remove records of ephemerals from before 1902 as they do not crossover with fire data
fire_ephemerals <- fire_ephemerals %>%
  filter(year > 1901)

fire <- st_make_valid(fire)

fire_within_nsw <- st_intersection(fire, nsw)

my_colours <- c("#d62728", "#1f77b4", "#2ca02c", "#6a3d9a", "brown", "#1088b9", "#e377c2")

ggplot() +
  geom_sf(data = nsw,
          fill = '#D2B48C40',
          colour = "darkgrey") +
  geom_sf(data = fire_within_nsw,
          colour = '#FF5A0080',
          fill = '#FF5A0020') +
  geom_point(data = fire_ephemerals,
             aes(x = decimalLongitude,
                 y = decimalLatitude,
                 color = scientificName)) +
  labs(title = 'Fire history and fire ephemeral species in NSW', color = 'Species') +
  scale_color_manual(values = my_colours) +
  theme_map() +
  theme(plot.background = element_rect(fill = "white", color = NA),
        text = element_text(family = "Arial"),
        legend.position = "right",
        plot.title = element_text(size = 15, hjust = 0.5))

ggsave('maps_graphs/ephemerals_nsw_map.png')


```

## Comparing area burnt to observations each year from 2013

Since fire ephemerals grow after fire events, we would expect to see a greater number of observations after fire. This code compares observations each year from 2013 to area burnt by fire in NSW. This found that no observations of Gyrostemon australasicus have been made after 2013, and as expected that observations of fire ephemerals increase after large fire events, particularly the 2019-2020 bushfires.

```{r}
#fire ephemeral records by year
obs_year <- fire_ephemerals %>% 
  group_by(scientificName, year) %>%
  summarise(count = n())

area_year <- fire %>%
  group_by(StartYear) %>%
  summarize(sum(AreaHa))

area_year_recent <- area_year %>%
filter(StartYear > 1999) %>%
  st_drop_geometry() %>%
  as.data.frame()

names(area_year_recent)[2] <- "AreaHa"

ggplot() +
  geom_bar(data = obs_year[obs_year$year > 2012, ], aes(fill = scientificName, y = count, x = year), position = "dodge", stat = "identity") +
  geom_line(data = area_year_recent[area_year_recent$StartYear > 2012, ], aes(x = StartYear, y = AreaHa/18000, group = 1), size = 1, alpha = 0.7) +
  labs(title = 'Fire area & fire ephemerals observations in NSW', fill = 'Species') +
  theme_fivethirtyeight() +
  theme(axis.title = element_text(), axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_y_continuous(name = "Observations", sec.axis = sec_axis(trans = ~.*18000, 
                        name = 'Area Burnt (ha)',
                        labels = scales::number_format(scale = 1, accuracy = 1),
                        breaks = seq(0, 5000000, by = 1000000))) 

```

## Density graphs - depicting regions of higher concentrations of ephemerals

```{r}

library(ggpointdensity)
library(ggplot2)
library(viridis)

ggplot() +
  geom_sf(data = nsw,
          fill = 'beige',
          colour = "darkgrey") +
  geom_sf(data = fire_within_nsw,
          colour = '#FF5A0080',
          fill = '#FF5A0020') +
  geom_pointdensity(data = fire_ephemerals,
             aes(x = decimalLongitude,
                 y = decimalLatitude)) +
  labs(title = 'Fire history and fire ephemerals in NSW', color = 'Observations') +
  scale_color_gradient(high = '#05450e', low = '#30d148') + 
  theme_map() +
  theme(plot.background = element_rect(fill = "white", color = NA),
        legend.position = "right",
        text = element_text(family = "Arial", size = 16))

ggsave('maps_graphs/ephemeral_density.png')

ggplot() +
  geom_sf(data = nsw,
          fill = 'beige',
          colour = "darkgrey") +
  geom_sf(data = fire_within_nsw,
          colour = '#FF5A0080',
          fill = '#FF5A0020') +
  stat_density_2d(data = fire_ephemerals,
                 contour = TRUE,
             aes(x = decimalLongitude,
                 y = decimalLatitude,
                 fill = after_stat(level),
                  bins = 5),
             geom = 'polygon',
             alpha = 0.5) +
  labs(title = 'Fire history and fire ephemerals in NSW', fill = 'Density') +
  scale_fill_viridis() + 
  theme_map() +
  theme(plot.background = element_rect(fill = "white", color = NA),
        legend.position = "right",
        text = element_text(family = "Arial", size = 14))

```

## Investigating observation sources over the years

```{r}

data_count <- fire_ephemerals %>%
  filter(year > 1999) %>%
  group_by(dataResourceName) %>%
  summarise(count = n()) |>
  arrange(desc(count))

top_4 <- data_count$dataResourceName[1:4]

fire_ephemerals %>%
  filter(year > 2012) %>%
  mutate(dataResourceCategory = ifelse(dataResourceName %in% top_4, as.character(dataResourceName), "Other")) %>%
  mutate(dataResourceCategory = factor(dataResourceCategory, levels = c(top_4, "Other"))) %>%
  ggplot() +
  geom_bar(aes(x = year, fill = dataResourceCategory)) +
  labs(x = 'Year', y = 'Observations', fill = 'Source') +
  theme_fivethirtyeight() +
  theme(axis.title = element_text(), axis.text.x = element_text(angle = 90, hjust = 1)) +
  guides(fill = guide_legend(ncol = 2))

ggsave('maps_graphs/obs_source_2013.png')
```

## Investigating observation sources for each species

```{r}
fire_ephemerals %>%
  filter(year > 2012) %>%
  mutate(dataResourceCategory = ifelse(dataResourceName %in% top_4, as.character(dataResourceName), "Other")) %>%
  mutate(dataResourceCategory = factor(dataResourceCategory, levels = c(top_4, "Other"))) %>%
  ggplot() +
  geom_bar(aes(x = str_wrap(scientificName, width = 15), fill = dataResourceCategory)) +
  labs(x = 'Year', y = 'Observations', fill = 'Source') +
  theme_fivethirtyeight() +
  theme(axis.title = element_text()) +
  guides(fill = guide_legend(ncol = 2)) 

```

```{r}
#country conservation
fire_ephemerals %>%
  filter(year > 2012) %>%
  ggplot() +
  geom_bar(aes(x = countryConservation, fill = scientificName)) +
  theme_classic()

#state conservation 
fire_ephemerals %>%
  filter(year > 2012) %>%
  ggplot() +
  geom_bar(aes(x = stateConservation, fill = scientificName)) +
  theme_classic()


```

```{r}



```

```{r}
```
